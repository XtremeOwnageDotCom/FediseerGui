@page "/instances/whitelisted"

@using global::Fediseer;

<PageTitle>Whitelisted Instances</PageTitle>

<FediseerGui.Models.AddEndorsement @ref=endorsementComponent />

<DataGrid TItem="InstanceDetails"
          Data="@instances"
          PageSize="50"
          ShowPager
          Filterable
          SortMode="DataGridSortMode.Single"
          Responsive>
    <DataGridColumns>
        <DataGridCommandColumn />
        <DataGridColumn Field="@nameof(InstanceDetails.Domain)" Caption="Domain" Sortable Filterable />
        <DataGridColumn Field="@nameof(InstanceDetails.Software)" Caption="Software" Sortable Filterable />
        <DataGridColumn Field="@nameof(InstanceDetails.Open_registrations)" Caption="Open Registration" Sortable Filterable />
        <DataGridColumn Field="@nameof(InstanceDetails.Email_verify)" Caption="Email Verification" Sortable Filterable />
        <DataGridColumn Field="@nameof(InstanceDetails.Approvals)" Caption="Approvals" Sortable Filterable=false />
        <DataGridColumn Field="@nameof(InstanceDetails.Endorsements)" Caption="Endorsements" Sortable Filterable=false />
        <DataGridColumn Field="@nameof(InstanceDetails.Guarantor)" Caption="Guarantor" Sortable />
        <DataGridColumn Field="@nameof(InstanceDetails.Domain)" Sortable=false Filterable=false>
            <DisplayTemplate>
                <RequiresLogin>
                    <Blazorise.Bootstrap.Button Color="Color.Success" Clicked="async () => await Endorse(context)">Endorse</Blazorise.Bootstrap.Button>
                </RequiresLogin>
            </DisplayTemplate>
        </DataGridColumn>
    </DataGridColumns>
    <EmptyTemplate>
        <div class="box">
            Please wait, retreiving instances
        </div>
    </EmptyTemplate>
</DataGrid>


@code {
    [CascadingParameter]
    public LocalStorage storage { get; set; }

    IEnumerable<InstanceDetails> instances { get; set; } = Enumerable.Empty<InstanceDetails>();
    private Models.AddEndorsement endorsementComponent { get; set; }

    private Task Endorse(InstanceDetails instance)
    {
        return endorsementComponent.ShowModal(instance);
    }
    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();

        var whitelistReponse = await storage.client.Get_whitelistAsync(storage.UserAgent, null, null, null, null, null);

        instances = whitelistReponse.Result.Instances;
    }
}
